---
title: "extravasation experiment analysis"
output: html_document
date: "2024-11-17"
---

#Analysis of trends from extravasation experiment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center')
```
load libraries

```{r, message = FALSE}
library(RSQLite)
library(dbplyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(xts)
library(ggfortify)
library(ggthemes)
library(maps)
library(mapdata)
library(leaflet)
library(remotes)
library(qst)
library(ymd)
library(tidyverse)
library(emmeans)
library(ggplot2)
library("readxl")

```

#Load data
```{r}

mydata=read_excel("C:/R/Resources/SplitData.xlsx")

#take a look at the data
glimpse(mydata)

#split data based on experiment index
df1 <- mydata[mydata$experiment == 1, ]
df2 <- mydata[mydata$experiment == 2, ]
df3 <- mydata[mydata$experiment == 3, ]
df4 <- mydata[mydata$experiment == 4, ]
df5 <- mydata[mydata$experiment == 5, ]


#take a look at the data
glimpse(df1)
glimpse(df2)
glimpse(df3)
glimpse(df4)
glimpse(df5)


#further split data based on condition
df1_2 <- df1[df1$condition == 2, ]
df1_4 <- df1[df1$condition == 4, ]
df1_6 <- df1[df1$condition == 6, ]

df2_2 <- df2[df2$condition == 2, ]
df2_4 <- df2[df2$condition == 4, ]
df2_6 <- df2[df2$condition == 6, ]

df3_2 <- df3[df3$condition == 2, ]
df3_4 <- df3[df3$condition == 4, ]
df3_6 <- df3[df3$condition == 6, ]

df4_2 <- df4[df4$condition == 2, ]
df4_4 <- df4[df4$condition == 4, ]
df4_6 <- df4[df4$condition == 6, ]

df5_2 <- df5[df5$condition == 2, ]
df5_4 <- df5[df5$condition == 4, ]
df5_6 <- df5[df5$condition == 6, ]


#take a look at the data
glimpse(df1_2)
glimpse(df1_4)
glimpse(df1_6)

glimpse(df2_2)
glimpse(df2_4)
glimpse(df2_6)

glimpse(df3_2)
glimpse(df3_4)
glimpse(df3_6)

glimpse(df4_2)
glimpse(df4_4)
glimpse(df4_6)

glimpse(df5_2)
glimpse(df5_4)
glimpse(df5_6)


```

#Analyze some basic trends. Look at count by time, and by condition
```{r}
#entire data set grouped by time
mydata %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count)) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time')

#each experiment separately grouped by time
df1 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df1))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 1')
df2 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 2')
df3 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df3))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 3')
df4 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 4')
df5 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df5))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 5')


```



```{r}
#entire data set grouped by condition
mydata %>% 
    group_by(condition) %>%
    ggplot(aes(x = condition, y = count)) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Condition')

#each experiment separately grouped by condition
df1 %>% 
    group_by(condition) %>%
    ggplot(aes(x = condition, y = count/nrow(df1))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Condition - Experiment 1')
df2 %>% 
    group_by(condition) %>%
    ggplot(aes(x = condition, y = count/nrow(df2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Condition - Experiment 2')
df3 %>% 
    group_by(condition) %>%
    ggplot(aes(x = condition, y = count/nrow(df3))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Condition - Experiment 3')
df4 %>% 
    group_by(condition) %>%
    ggplot(aes(x = condition, y = count/nrow(df4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Condition - Experiment 4')
df5 %>% 
    group_by(condition) %>%
    ggplot(aes(x = condition, y = count/nrow(df5))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Condition - Experiment 5')




```

```{r}
#each experiment and condition separately (vs time)
df1_2 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df1_2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 1, Condition 2')
df1_4 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df1_4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 1, Condition 4')
df1_6 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df1_6))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 1, Condition 6')

df2_2 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df2_2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 2, Condition 2')
df2_4 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df2_4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 2, Condition 4')
df2_6 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df2_6))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 2, Condition 6')

df3_2 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df3_2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 3, Condition 2')
df3_4 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df3_4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 3, Condition 4')
df3_6 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df3_6))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 3, Condition 6')

df4_2 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df4_2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 4, Condition 2')
df4_4 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df4_4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 4, Condition 4')
df4_6 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df4_6))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 4, Condition 6')

df5_2 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df5_2))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 5, Condition 2')
df5_4 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df5_4))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 5, Condition 4')
df5_6 %>% 
    group_by(time) %>%
    ggplot(aes(x = time, y = count/nrow(df5_6))) + 
    geom_bar(stat = 'identity', fill = 'orange') +
    geom_smooth(method = 'lm', se = FALSE, linetype = 'dashed', size = 0.4, color = 'red') + 
    labs(x = '', y = 'Count', title = 'Count by Time - Experiment 5, Condition 6')

```


#run simple linear regression analysis
```{r}
#for all experiments
experiment=as.factor(mydata$experiment)
condition=as.factor(mydata$condition)
time = mydata$time #time is a continuous variable
count=mydata$count
fit1 = lm(count~ experiment+condition+time)
par(mfrow=c(2,2))
plot(fit1)
summary(fit1)

```
#Quick analysis: experiments 2 and 5 are not statistically different from experiment 1
# conditions 4 and 6 are statistically different from condition 2
# the model is linear with respect to time (statistically significant)
# intercept is not statistically siginificant
#observations 132, 461, 476 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)

# Re-run with experiments 1, 2, 5 separately from experiments 3, 4
```{r}
#for experiments 1, 2, 5
updated <- rbind(df1, df2, df5)
experiment=as.factor(updated$experiment)
condition=as.factor(updated$condition)
time = updated$time #time is a continuous variable
count=updated$count
fit1 = lm(count~ experiment+condition+time)
par(mfrow=c(2,2))
plot(fit1)
summary(fit1)
```
#Quick analysis: experiments 2 and 5 are not statistically different from experiment 1
# condition 4 is not statistically different from condition 2, but just barely above the significance threshold of 0.05 so nothing to do here
# the model is linear with respect to time (statistically significant)
# intercept is statistically siginificant
# observations 132, 263, 278 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)
```{r}
#for experiments 3 and 4
updated <- rbind(df3, df4)
experiment=as.factor(updated$experiment)
condition=as.factor(updated$condition)
time = updated$time #time is a continuous variable
count=updated$count
fit1 = lm(count~ experiment+condition+time)
par(mfrow=c(2,2))
plot(fit1)
summary(fit1)
```
#Quick analysis: experiment 4 is statistically different from experiment 3 (should analyze them separately)
# condition 4 is statistically different from condition 2, but just barely below the significance threshold of 0.05 so nothing to do here
# the model is linear with respect to time (statistically significant)
# intercept is statistically siginificant
#observations 92, 95, 198 have high residuals (likely outliers) and are also high levarage points (should be removed)

# Re-run with experiments 3 and 4 separately
```{r}

#experiment 3
condition=as.factor(df3$condition)
time = df3$time
count=df3$count
fit_df3 = lm(count~condition+time)
par(mfrow=c(2,2))
plot(fit_df3)
summary(fit_df3)

#experiment 4
condition=as.factor(df4$condition)
time = df4$time
count=df4$count
fit_df4 = lm(count~condition+time)
par(mfrow=c(2,2))
plot(fit_df4)
summary(fit_df4)
```
#Quick analysis of experiment 3:
# conditions 4 and 6 are statistically different from condition 2
# the model is linear with respect to time (statistically significant)
# intercept is statistically siginificant
# observations 92, 95 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)


#Quick analysis of experiment 4:
# condition 4 is not statistically different from condition 2
# the model is linear with respect to time (statistically significant)
# intercept is statistically siginificant
# observations 92, 95 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)


```{r}
#each remaining experiment one at a time (1, 2 and 5)
#####################################################

#experiment 1
condition=as.factor(df1$condition)
time = df1$time
count=df1$count
fit_df1 = lm(count~condition+time)
par(mfrow=c(2,2))
plot(fit_df1)
summary(fit_df1)

#experiment 2
condition=as.factor(df2$condition)
time = df2$time
count=df2$count
fit_df2 = lm(count~condition+time)
par(mfrow=c(2,2))
plot(fit_df2)
summary(fit_df2)

#experiment 5
condition=as.factor(df5$condition)
time = df5$time
count=df5$count
fit_df5 = lm(count~condition+time)
par(mfrow=c(2,2))
plot(fit_df5)
summary(fit_df5)
```
#Quick analysis of experiment 1:
# condition 6 is not statistically different from condition 2
# the model is linear with respect to time (statistically significant)
# intercept is not statistically siginificant
# observations 47, 50 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)

#Quick analysis of experiment 2:
# conditions 4 and 6 are statistically different from condition 2
# the model is linear with respect to time (statistically significant)
# intercept is statistically siginificant
# observations 91, 51, 61 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)

#Quick analysis of experiment 5:
# conditions 4 and 6 are statistically different from condition 2
# the model is linear with respect to time (statistically significant)
# intercept is not statistically siginificant
# observations 92, 107 have high residuals (likely outliers) and are also high levarage points and/or have large Cook's distance (should be removed)




```{r}

```
#Experiment with different varaince models in GLS
```{r}
lncount = mydata$lncountadj
lntime = mydata$lntimeadj
#fit3 = nlme::gls(count ~ experiment+condition:time, data = mydata,
#          weights = varIdent(form = ~1 | condition:experiment))
fit3 = nlme::gls(count ~ experiment+condition:time, data = mydata)
par(mfrow=c(2,2))
plot(fit3)
summary(fit3)
